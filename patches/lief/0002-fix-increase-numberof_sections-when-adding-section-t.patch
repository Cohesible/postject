From e6032a5a5415a474fb679ceed051fb0caf59efdf Mon Sep 17 00:00:00 2001
From: David Sanders <david.sanders@postman.com>
Date: Fri, 17 Jun 2022 19:51:19 -0700
Subject: [PATCH] fix: increase numberof_sections when adding section to Mach-O
 segment

---
 src/MachO/SegmentCommand.cpp |  1 +
 tests/macho/test_generic.py  | 22 ++++++++++++++++++++++
 2 files changed, 23 insertions(+)

diff --git a/src/MachO/SegmentCommand.cpp b/src/MachO/SegmentCommand.cpp
index f49de1d..72ffc41 100644
--- a/src/MachO/SegmentCommand.cpp
+++ b/src/MachO/SegmentCommand.cpp
@@ -259,6 +259,7 @@ Section& SegmentCommand::add_section(const Section& section) {
 
   file_size(data_.size());
   sections_.push_back(std::move(new_section));
+  numberof_sections(numberof_sections() + 1);
   return *sections_.back();
 }
 
diff --git a/tests/macho/test_generic.py b/tests/macho/test_generic.py
index 602b667..9a38cb8 100644
--- a/tests/macho/test_generic.py
+++ b/tests/macho/test_generic.py
@@ -220,3 +220,25 @@ def test_get_section():
     sample = get_sample("MachO/MachO64_x86-64_binary_large-bss.bin")
     macho = lief.parse(sample)
     assert macho.get_section("__DATA_CONST", "__got") is not None
+
+
+def test_segment_add_section():
+    binary = lief.parse(get_sample('MachO/MachO64_x86-64_binary_safaridriver.bin'))
+
+    section = lief.MachO.Section("__bar", [1, 2, 3])
+
+    existing_segment = binary.get_segment("__TEXT")
+    new_segment = lief.MachO.SegmentCommand("__FOO")
+
+    for segment in (existing_segment, new_segment):
+        assert not segment.has_section(section.name)
+        assert not segment.has(section)
+        assert segment.numberof_sections == len(segment.sections)
+
+        numberof_sections = segment.numberof_sections
+
+        section = segment.add_section(section)
+        assert segment.numberof_sections == numberof_sections + 1
+        assert segment.has_section(section.name)
+        assert segment.has(section)
+        assert section in segment.sections
-- 
2.32.0 (Apple Git-132)

